<?xml version="1.0" encoding="UTF-8"?>

<launch>
  <!-- gazebo args -->
  <arg name="world_name" default="$(find lar_gazebo)/worlds/lar.world"/>
  <arg name="paused" default="true" doc="Starts gazebo in paused mode" />
  <arg name="gui" default="true" doc="Starts gazebo gui" />

  <!-- husky_gazebo args -->
  <arg name="robot_namespace" default="/"/>

  <!-- Position of Husky -->
  <arg name="x" default="4.65"/>
  <arg name="y" default="3.0"/>
  <arg name="z" default="0.1"/>
  <arg name="yaw" default="0.0"/>

  <!-- Include world launch -->
  <include file="$(find lar_gazebo)/launch/lar_world.launch">
    <arg name="world_name" value="$(arg world_name)"/>
    <arg name="gui" value="$(arg gui)"/>
    <arg name="paused" value="$(arg paused)"/>
  </include>

  <!-- Include husky_gazebo launcher -->
  <include file="$(find husky_gazebo)/launch/spawn_husky.launch">
    <arg name="robot_namespace" value="$(arg robot_namespace)"/>
    <arg name="x" value="$(arg x)"/>
    <arg name="y" value="$(arg y)"/>
    <arg name="z" value="$(arg z)"/>
    <arg name="yaw" value="$(arg yaw)"/>
  </include>

  <!-- Point Cloud to Laserscan -->
  <node pkg="pointcloud_to_laserscan" type="pointcloud_to_laserscan_node" name="pointcloud_to_laserscan">
    <remap from="cloud_in" to="/velodyne_points"/>
    <remap from="scan" to="/front/scan"/>
  </node>

  <!-- Include AMCL -->
  <arg name="use_map_topic" default="true"/>
  <arg name="scan_topic" default="front/scan" />

  <node pkg="amcl" type="amcl" name="amcl">
    <param name="use_map_topic" value="$(arg use_map_topic)"/>
    <!-- Publish scans from best pose at a max of 10 Hz -->
    <param name="odom_model_type" value="diff"/>
    <param name="odom_alpha5" value="0.1"/>
    <param name="gui_publish_rate" value="10.0"/>
    <param name="laser_max_beams" value="60"/>
    <param name="laser_max_range" value="12.0"/>
    <param name="min_particles" value="500"/>
    <param name="max_particles" value="2000"/>
    <param name="kld_err" value="0.05"/>
    <param name="kld_z" value="0.99"/>
    <param name="odom_alpha1" value="0.2"/>
    <param name="odom_alpha2" value="0.2"/>
    <!-- translation std dev, m -->
    <param name="odom_alpha3" value="0.2"/>
    <param name="odom_alpha4" value="0.2"/>
    <param name="laser_z_hit" value="0.5"/>
    <param name="laser_z_short" value="0.05"/>
    <param name="laser_z_max" value="0.05"/>
    <param name="laser_z_rand" value="0.5"/>
    <param name="laser_sigma_hit" value="0.2"/>
    <param name="laser_lambda_short" value="0.1"/>
    <param name="laser_model_type" value="likelihood_field"/>
    <!-- <param name="laser_model_type" value="beam"/> -->
    <param name="laser_likelihood_max_dist" value="2.0"/>
    <param name="update_min_d" value="0.25"/>
    <param name="update_min_a" value="0.2"/>
    <param name="odom_frame_id" value="odom"/>
    <param name="resample_interval" value="1"/>
    <!-- Increase tolerance because the computer can get quite busy -->
    <param name="transform_tolerance" value="1.0"/>
    <param name="recovery_alpha_slow" value="0.0"/>
    <param name="recovery_alpha_fast" value="0.0"/>
    <param name="tf_broadcast" value="false"/>
    <remap from="scan" to="$(arg scan_topic)"/>
  </node>

  <!-- Include Gmapping -->
  <include file="$(find husky_navigation)/launch/gmapping.launch"/>

  <!-- EKF Localization Node for AMCL Fusion -->
  <node pkg="robot_localization" type="ekf_localization_node" name="ekf_world_map" clear_params="true">
    <param name="map_frame" value="map"/>
    <param name="odom_frame" value="odom"/>
    <param name="base_link_frame" value="base_link"/>
    <param name="world_frame" value="map"/>  

    <param name="two_d_mode" value="true"/>  
    <param name="predict_to_current_time" value="true"/>  
    <param name="frequency" value="50"/>  

    <param name="odom0" value="/husky_velocity_controller/odom"/>
    <rosparam param="odom0_config">
      [false, false, false,
      false, false, false,
      true, true, true,
      false, false, true,
      false, false, false]
    </rosparam>
    <param name="odom0_differential" value="false"/>
    <param name="odom0_queue_size" value="100"/>

    <param name="pose0" value="/amcl_pose"/>
    <rosparam param="pose0_config">
      [true, true, true,
      true, true, true,
      false, false, false,
      false, false, false,
      false, false, false]
    </rosparam>
    <param name="pose0_queue_size" value="100"/>
    <remap from="/odometry/filtered" to="/odometry/filtered_map"/>
  </node>

  <!-- Include topics for husky keyboard control -->
  <group ns="kb_teleop">
    <node pkg="teleop_twist_keyboard" type="teleop_twist_keyboard.py" name="teleop_twist_kb"/>
  </group>

  <!-- Rosbag recording -->

  <node pkg="rosbag" type="record" name="rosbag_record_cam"
       args="record -o $(find lar_gazebo)/bags/odom_comp /husky_velocity_controller/odom
       /amcl_pose /odometry/filtered"/>

  <!-- RViz -->
  <node type="rviz" name="rviz" pkg="rviz" args="-d $(find lar_gazebo)/config/lar_husky.rviz"/>

</launch>
